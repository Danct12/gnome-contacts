/* contacts-avatar-selector.c generated by valac 0.47.2.1-ce69, the Vala compiler
 * generated from contacts-avatar-selector.vala, do not modify */

/* -*- Mode: vala; indent-tabs-mode: t; c-basic-offset: 2; tab-width: 8 -*- */
/*
 * Copyright (C) 2011 Alexander Larsson <alexl@redhat.com>
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include <gtk/gtk.h>
#include <glib-object.h>
#include <libgnome-desktop/gnome-desktop-thumbnail.h>
#include <folks/folks.h>
#include <glib.h>
#include <cheese/cheese-camera-device-monitor.h>
#include <stdlib.h>
#include <string.h>
#include <cheese/cheese-camera-device.h>
#include <gdk-pixbuf/gdk-pixbuf.h>
#include <math.h>
#include <float.h>
#include <gio/gio.h>
#include "contacts.h"
#include <glib/gi18n-lib.h>
#include <gee.h>

#define CONTACTS_TYPE_AVATAR_SELECTOR (contacts_avatar_selector_get_type ())
#define CONTACTS_AVATAR_SELECTOR(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), CONTACTS_TYPE_AVATAR_SELECTOR, ContactsAvatarSelector))
#define CONTACTS_AVATAR_SELECTOR_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), CONTACTS_TYPE_AVATAR_SELECTOR, ContactsAvatarSelectorClass))
#define CONTACTS_IS_AVATAR_SELECTOR(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), CONTACTS_TYPE_AVATAR_SELECTOR))
#define CONTACTS_IS_AVATAR_SELECTOR_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), CONTACTS_TYPE_AVATAR_SELECTOR))
#define CONTACTS_AVATAR_SELECTOR_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), CONTACTS_TYPE_AVATAR_SELECTOR, ContactsAvatarSelectorClass))

typedef struct _ContactsAvatarSelector ContactsAvatarSelector;
typedef struct _ContactsAvatarSelectorClass ContactsAvatarSelectorClass;
typedef struct _ContactsAvatarSelectorPrivate ContactsAvatarSelectorPrivate;
enum  {
	CONTACTS_AVATAR_SELECTOR_0_PROPERTY,
	CONTACTS_AVATAR_SELECTOR_NUM_PROPERTIES
};
static GParamSpec* contacts_avatar_selector_properties[CONTACTS_AVATAR_SELECTOR_NUM_PROPERTIES];
#define _g_object_unref0(var) ((var == NULL) ? NULL : (var = (g_object_unref (var), NULL)))
#define _g_thread_unref0(var) ((var == NULL) ? NULL : (var = (g_thread_unref (var), NULL)))
#define _g_bytes_unref0(var) ((var == NULL) ? NULL : (var = (g_bytes_unref (var), NULL)))
#define _g_error_free0(var) ((var == NULL) ? NULL : (var = (g_error_free (var), NULL)))
typedef struct _Block8Data Block8Data;

#define CONTACTS_TYPE_AVATAR (contacts_avatar_get_type ())
#define CONTACTS_AVATAR(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), CONTACTS_TYPE_AVATAR, ContactsAvatar))
#define CONTACTS_AVATAR_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), CONTACTS_TYPE_AVATAR, ContactsAvatarClass))
#define CONTACTS_IS_AVATAR(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), CONTACTS_TYPE_AVATAR))
#define CONTACTS_IS_AVATAR_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), CONTACTS_TYPE_AVATAR))
#define CONTACTS_AVATAR_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), CONTACTS_TYPE_AVATAR, ContactsAvatarClass))

typedef struct _ContactsAvatar ContactsAvatar;
typedef struct _ContactsAvatarClass ContactsAvatarClass;
#define _g_free0(var) (var = (g_free (var), NULL))

#define CONTACTS_TYPE_CROP_CHEESE_DIALOG (contacts_crop_cheese_dialog_get_type ())
#define CONTACTS_CROP_CHEESE_DIALOG(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), CONTACTS_TYPE_CROP_CHEESE_DIALOG, ContactsCropCheeseDialog))
#define CONTACTS_CROP_CHEESE_DIALOG_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), CONTACTS_TYPE_CROP_CHEESE_DIALOG, ContactsCropCheeseDialogClass))
#define CONTACTS_IS_CROP_CHEESE_DIALOG(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), CONTACTS_TYPE_CROP_CHEESE_DIALOG))
#define CONTACTS_IS_CROP_CHEESE_DIALOG_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), CONTACTS_TYPE_CROP_CHEESE_DIALOG))
#define CONTACTS_CROP_CHEESE_DIALOG_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), CONTACTS_TYPE_CROP_CHEESE_DIALOG, ContactsCropCheeseDialogClass))

typedef struct _ContactsCropCheeseDialog ContactsCropCheeseDialog;
typedef struct _ContactsCropCheeseDialogClass ContactsCropCheeseDialogClass;

#define CONTACTS_TYPE_WINDOW (contacts_window_get_type ())
#define CONTACTS_WINDOW(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), CONTACTS_TYPE_WINDOW, ContactsWindow))
#define CONTACTS_WINDOW_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), CONTACTS_TYPE_WINDOW, ContactsWindowClass))
#define CONTACTS_IS_WINDOW(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), CONTACTS_TYPE_WINDOW))
#define CONTACTS_IS_WINDOW_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), CONTACTS_TYPE_WINDOW))
#define CONTACTS_WINDOW_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), CONTACTS_TYPE_WINDOW, ContactsWindowClass))

typedef struct _ContactsWindow ContactsWindow;
typedef struct _ContactsWindowClass ContactsWindowClass;
typedef struct _Block9Data Block9Data;
enum  {
	CONTACTS_AVATAR_SELECTOR_SET_AVATAR_SIGNAL,
	CONTACTS_AVATAR_SELECTOR_NUM_SIGNALS
};
static guint contacts_avatar_selector_signals[CONTACTS_AVATAR_SELECTOR_NUM_SIGNALS] = {0};

struct _ContactsAvatarSelector {
	GtkPopover parent_instance;
	ContactsAvatarSelectorPrivate * priv;
};

struct _ContactsAvatarSelectorClass {
	GtkPopoverClass parent_class;
};

struct _ContactsAvatarSelectorPrivate {
	GnomeDesktopThumbnailFactory* thumbnail_factory;
	FolksIndividual* individual;
	GtkFlowBox* personas_thumbnail_grid;
	GtkFlowBox* stock_thumbnail_grid;
	GtkButton* cheese_button;
	gint num_cameras;
	CheeseCameraDeviceMonitor* camera_monitor;
};

struct _Block8Data {
	int _ref_count_;
	ContactsAvatarSelector* self;
	GdkPixbuf* source_pixbuf;
};

struct _Block9Data {
	int _ref_count_;
	ContactsAvatarSelector* self;
	GtkFileChooserNative* chooser;
};

static gint ContactsAvatarSelector_private_offset;
static gpointer contacts_avatar_selector_parent_class = NULL;

GType contacts_avatar_selector_get_type (void) G_GNUC_CONST;
G_DEFINE_AUTOPTR_CLEANUP_FUNC (ContactsAvatarSelector, g_object_unref)
#define CONTACTS_AVATAR_SELECTOR_ICONS_SIZE 64
#define CONTACTS_AVATAR_SELECTOR_MAIN_SIZE 128
#define CONTACTS_AVATAR_SELECTOR_AVATAR_BUTTON_CSS_NAME "avatar-button"
ContactsAvatarSelector* contacts_avatar_selector_new (GtkWidget* relative,
                                                      FolksIndividual* individual);
ContactsAvatarSelector* contacts_avatar_selector_construct (GType object_type,
                                                            GtkWidget* relative,
                                                            FolksIndividual* individual);
static void contacts_avatar_selector_update_thumbnail_grids (ContactsAvatarSelector* self);
static void __lambda15_ (ContactsAvatarSelector* self);
static void ___lambda15__cheese_camera_device_monitor_added (CheeseCameraDeviceMonitor* _sender,
                                                      CheeseCameraDevice* device,
                                                      gpointer self);
static void __lambda16_ (ContactsAvatarSelector* self);
static void ___lambda16__cheese_camera_device_monitor_removed (CheeseCameraDeviceMonitor* _sender,
                                                        const gchar* uuid,
                                                        gpointer self);
static void* __lambda17_ (ContactsAvatarSelector* self);
static gpointer ___lambda17__gthread_func (gpointer self);
static GdkPixbuf* contacts_avatar_selector_scale_pixbuf_for_avatar_use (ContactsAvatarSelector* self,
                                                                 GdkPixbuf* pixbuf);
static void contacts_avatar_selector_selected_pixbuf (ContactsAvatarSelector* self,
                                               GdkPixbuf* pixbuf);
static GtkFlowBoxChild* contacts_avatar_selector_create_thumbnail (ContactsAvatarSelector* self,
                                                            GdkPixbuf* source_pixbuf);
static Block8Data* block8_data_ref (Block8Data* _data8_);
static void block8_data_unref (void * _userdata_);
GType contacts_avatar_get_type (void) G_GNUC_CONST;
G_DEFINE_AUTOPTR_CLEANUP_FUNC (ContactsAvatar, g_object_unref)
ContactsAvatar* contacts_avatar_new (gint size,
                                     FolksIndividual* individual);
ContactsAvatar* contacts_avatar_construct (GType object_type,
                                           gint size,
                                           FolksIndividual* individual);
void contacts_avatar_set_pixbuf (ContactsAvatar* self,
                                 GdkPixbuf* a_pixbuf);
static void __lambda14_ (Block8Data* _data8_);
static void ___lambda14__gtk_button_clicked (GtkButton* _sender,
                                      gpointer self);
static GtkFlowBoxChild* contacts_avatar_selector_thumbnail_for_persona (ContactsAvatarSelector* self,
                                                                 FolksPersona* persona);
static GtkFlowBoxChild* contacts_avatar_selector_thumbnail_for_filename (ContactsAvatarSelector* self,
                                                                  const gchar* filename);
static void contacts_avatar_selector_on_cheese_clicked (ContactsAvatarSelector* self,
                                                 GtkButton* button);
GType contacts_crop_cheese_dialog_get_type (void) G_GNUC_CONST;
G_DEFINE_AUTOPTR_CLEANUP_FUNC (ContactsCropCheeseDialog, g_object_unref)
GType contacts_window_get_type (void) G_GNUC_CONST;
G_DEFINE_AUTOPTR_CLEANUP_FUNC (ContactsWindow, g_object_unref)
ContactsCropCheeseDialog* contacts_crop_cheese_dialog_new_for_cheese (GtkWindow* parent);
ContactsCropCheeseDialog* contacts_crop_cheese_dialog_construct_for_cheese (GType object_type,
                                                                            GtkWindow* parent);
static void __lambda19_ (ContactsAvatarSelector* self,
                  GdkPixbuf* pix);
static void ___lambda19__contacts_crop_cheese_dialog_picture_selected (ContactsCropCheeseDialog* _sender,
                                                                GdkPixbuf* buf,
                                                                gpointer self);
static void _contacts_avatar_selector_on_cheese_clicked_gtk_button_clicked (GtkButton* _sender,
                                                                     gpointer self);
static void contacts_avatar_selector_on_file_clicked (ContactsAvatarSelector* self,
                                               GtkButton* button);
static Block9Data* block9_data_ref (Block9Data* _data9_);
static void block9_data_unref (void * _userdata_);
static void contacts_avatar_selector_update_preview (ContactsAvatarSelector* self,
                                              GtkFileChooser* chooser);
static void _contacts_avatar_selector_update_preview_gtk_file_chooser_update_preview (GtkFileChooser* _sender,
                                                                               gpointer self);
static void __lambda20_ (Block9Data* _data9_,
                  gint response);
ContactsCropCheeseDialog* contacts_crop_cheese_dialog_new_for_crop (GtkWindow* parent,
                                                                    GdkPixbuf* pixbuf);
ContactsCropCheeseDialog* contacts_crop_cheese_dialog_construct_for_crop (GType object_type,
                                                                          GtkWindow* parent,
                                                                          GdkPixbuf* pixbuf);
static void ____lambda21_ (ContactsAvatarSelector* self,
                    GdkPixbuf* pix);
static void _____lambda21__contacts_crop_cheese_dialog_picture_selected (ContactsCropCheeseDialog* _sender,
                                                                  GdkPixbuf* buf,
                                                                  gpointer self);
static void ___lambda20__gtk_native_dialog_response (GtkNativeDialog* _sender,
                                              gint response_id,
                                              gpointer self);
static void _contacts_avatar_selector_on_file_clicked_gtk_button_clicked (GtkButton* _sender,
                                                                   gpointer self);
static void contacts_avatar_selector_finalize (GObject * obj);
static GType contacts_avatar_selector_get_type_once (void);
static void _vala_array_destroy (gpointer array,
                          gint array_length,
                          GDestroyNotify destroy_func);
static void _vala_array_free (gpointer array,
                       gint array_length,
                       GDestroyNotify destroy_func);

static inline gpointer
contacts_avatar_selector_get_instance_private (ContactsAvatarSelector* self)
{
	return G_STRUCT_MEMBER_P (self, ContactsAvatarSelector_private_offset);
}

static gpointer
_g_object_ref0 (gpointer self)
{
#line 59 "../src/contacts-avatar-selector.vala"
	return self ? g_object_ref (self) : NULL;
#line 238 "contacts-avatar-selector.c"
}

static void
__lambda15_ (ContactsAvatarSelector* self)
{
	gint _tmp0_;
	GtkButton* _tmp1_;
#line 70 "../src/contacts-avatar-selector.vala"
	_tmp0_ = self->priv->num_cameras;
#line 70 "../src/contacts-avatar-selector.vala"
	self->priv->num_cameras = _tmp0_ + 1;
#line 71 "../src/contacts-avatar-selector.vala"
	_tmp1_ = self->priv->cheese_button;
#line 71 "../src/contacts-avatar-selector.vala"
	gtk_widget_set_sensitive ((GtkWidget*) _tmp1_, self->priv->num_cameras > 0);
#line 254 "contacts-avatar-selector.c"
}

static void
___lambda15__cheese_camera_device_monitor_added (CheeseCameraDeviceMonitor* _sender,
                                                 CheeseCameraDevice* device,
                                                 gpointer self)
{
#line 69 "../src/contacts-avatar-selector.vala"
	__lambda15_ ((ContactsAvatarSelector*) self);
#line 264 "contacts-avatar-selector.c"
}

static void
__lambda16_ (ContactsAvatarSelector* self)
{
	gint _tmp0_;
	GtkButton* _tmp1_;
#line 74 "../src/contacts-avatar-selector.vala"
	_tmp0_ = self->priv->num_cameras;
#line 74 "../src/contacts-avatar-selector.vala"
	self->priv->num_cameras = _tmp0_ - 1;
#line 75 "../src/contacts-avatar-selector.vala"
	_tmp1_ = self->priv->cheese_button;
#line 75 "../src/contacts-avatar-selector.vala"
	gtk_widget_set_sensitive ((GtkWidget*) _tmp1_, self->priv->num_cameras > 0);
#line 280 "contacts-avatar-selector.c"
}

static void
___lambda16__cheese_camera_device_monitor_removed (CheeseCameraDeviceMonitor* _sender,
                                                   const gchar* uuid,
                                                   gpointer self)
{
#line 73 "../src/contacts-avatar-selector.vala"
	__lambda16_ ((ContactsAvatarSelector*) self);
#line 290 "contacts-avatar-selector.c"
}

static void*
__lambda17_ (ContactsAvatarSelector* self)
{
	CheeseCameraDeviceMonitor* _tmp0_;
	void* result = NULL;
#line 79 "../src/contacts-avatar-selector.vala"
	_tmp0_ = self->priv->camera_monitor;
#line 79 "../src/contacts-avatar-selector.vala"
	cheese_camera_device_monitor_coldplug (_tmp0_);
#line 80 "../src/contacts-avatar-selector.vala"
	result = NULL;
#line 80 "../src/contacts-avatar-selector.vala"
	return result;
#line 306 "contacts-avatar-selector.c"
}

static gpointer
___lambda17__gthread_func (gpointer self)
{
	gpointer result;
	result = __lambda17_ ((ContactsAvatarSelector*) self);
#line 78 "../src/contacts-avatar-selector.vala"
	g_object_unref (self);
#line 78 "../src/contacts-avatar-selector.vala"
	return result;
#line 318 "contacts-avatar-selector.c"
}

ContactsAvatarSelector*
contacts_avatar_selector_construct (GType object_type,
                                    GtkWidget* relative,
                                    FolksIndividual* individual)
{
	ContactsAvatarSelector * self = NULL;
	GnomeDesktopThumbnailFactory* _tmp0_;
	FolksIndividual* _tmp1_;
	GtkButton* _tmp2_;
	GtkButton* _tmp3_;
	CheeseCameraDeviceMonitor* _tmp4_;
	CheeseCameraDeviceMonitor* _tmp5_;
	CheeseCameraDeviceMonitor* _tmp6_;
	GThread* _tmp7_;
	GThread* _tmp8_;
#line 56 "../src/contacts-avatar-selector.vala"
	g_return_val_if_fail (relative != NULL, NULL);
#line 56 "../src/contacts-avatar-selector.vala"
	self = (ContactsAvatarSelector*) g_object_new (object_type, NULL);
#line 57 "../src/contacts-avatar-selector.vala"
	gtk_popover_set_relative_to ((GtkPopover*) self, relative);
#line 58 "../src/contacts-avatar-selector.vala"
	_tmp0_ = gnome_desktop_thumbnail_factory_new (GNOME_DESKTOP_THUMBNAIL_SIZE_NORMAL);
#line 58 "../src/contacts-avatar-selector.vala"
	_g_object_unref0 (self->priv->thumbnail_factory);
#line 58 "../src/contacts-avatar-selector.vala"
	self->priv->thumbnail_factory = _tmp0_;
#line 59 "../src/contacts-avatar-selector.vala"
	_tmp1_ = _g_object_ref0 (individual);
#line 59 "../src/contacts-avatar-selector.vala"
	_g_object_unref0 (self->priv->individual);
#line 59 "../src/contacts-avatar-selector.vala"
	self->priv->individual = _tmp1_;
#line 61 "../src/contacts-avatar-selector.vala"
	contacts_avatar_selector_update_thumbnail_grids (self);
#line 64 "../src/contacts-avatar-selector.vala"
	_tmp2_ = self->priv->cheese_button;
#line 64 "../src/contacts-avatar-selector.vala"
	gtk_widget_set_visible ((GtkWidget*) _tmp2_, TRUE);
#line 65 "../src/contacts-avatar-selector.vala"
	_tmp3_ = self->priv->cheese_button;
#line 65 "../src/contacts-avatar-selector.vala"
	gtk_widget_set_sensitive ((GtkWidget*) _tmp3_, FALSE);
#line 68 "../src/contacts-avatar-selector.vala"
	_tmp4_ = (CheeseCameraDeviceMonitor*) cheese_camera_device_monitor_new ();
#line 68 "../src/contacts-avatar-selector.vala"
	_g_object_unref0 (self->priv->camera_monitor);
#line 68 "../src/contacts-avatar-selector.vala"
	self->priv->camera_monitor = _tmp4_;
#line 69 "../src/contacts-avatar-selector.vala"
	_tmp5_ = self->priv->camera_monitor;
#line 69 "../src/contacts-avatar-selector.vala"
	g_signal_connect_object (_tmp5_, "added", (GCallback) ___lambda15__cheese_camera_device_monitor_added, self, 0);
#line 73 "../src/contacts-avatar-selector.vala"
	_tmp6_ = self->priv->camera_monitor;
#line 73 "../src/contacts-avatar-selector.vala"
	g_signal_connect_object (_tmp6_, "removed", (GCallback) ___lambda16__cheese_camera_device_monitor_removed, self, 0);
#line 78 "../src/contacts-avatar-selector.vala"
	_tmp7_ = g_thread_new ("camera-loader", ___lambda17__gthread_func, g_object_ref (self));
#line 78 "../src/contacts-avatar-selector.vala"
	_tmp8_ = _tmp7_;
#line 78 "../src/contacts-avatar-selector.vala"
	_g_thread_unref0 (_tmp8_);
#line 56 "../src/contacts-avatar-selector.vala"
	return self;
#line 386 "contacts-avatar-selector.c"
}

ContactsAvatarSelector*
contacts_avatar_selector_new (GtkWidget* relative,
                              FolksIndividual* individual)
{
#line 56 "../src/contacts-avatar-selector.vala"
	return contacts_avatar_selector_construct (CONTACTS_TYPE_AVATAR_SELECTOR, relative, individual);
#line 395 "contacts-avatar-selector.c"
}

static GdkPixbuf*
contacts_avatar_selector_scale_pixbuf_for_avatar_use (ContactsAvatarSelector* self,
                                                      GdkPixbuf* pixbuf)
{
	gint w = 0;
	gint h = 0;
	gboolean _tmp0_ = FALSE;
	GdkPixbuf* _tmp2_;
	GdkPixbuf* result = NULL;
#line 85 "../src/contacts-avatar-selector.vala"
	g_return_val_if_fail (self != NULL, NULL);
#line 85 "../src/contacts-avatar-selector.vala"
	g_return_val_if_fail (pixbuf != NULL, NULL);
#line 86 "../src/contacts-avatar-selector.vala"
	w = gdk_pixbuf_get_width (pixbuf);
#line 87 "../src/contacts-avatar-selector.vala"
	h = gdk_pixbuf_get_height (pixbuf);
#line 89 "../src/contacts-avatar-selector.vala"
	if (w <= CONTACTS_AVATAR_SELECTOR_MAIN_SIZE) {
#line 89 "../src/contacts-avatar-selector.vala"
		_tmp0_ = h <= CONTACTS_AVATAR_SELECTOR_MAIN_SIZE;
#line 419 "contacts-avatar-selector.c"
	} else {
#line 89 "../src/contacts-avatar-selector.vala"
		_tmp0_ = FALSE;
#line 423 "contacts-avatar-selector.c"
	}
#line 89 "../src/contacts-avatar-selector.vala"
	if (_tmp0_) {
#line 427 "contacts-avatar-selector.c"
		GdkPixbuf* _tmp1_;
#line 90 "../src/contacts-avatar-selector.vala"
		_tmp1_ = _g_object_ref0 (pixbuf);
#line 90 "../src/contacts-avatar-selector.vala"
		result = _tmp1_;
#line 90 "../src/contacts-avatar-selector.vala"
		return result;
#line 435 "contacts-avatar-selector.c"
	}
#line 92 "../src/contacts-avatar-selector.vala"
	if (w > h) {
#line 93 "../src/contacts-avatar-selector.vala"
		h = (gint) round ((gdouble) ((h * ((gfloat) CONTACTS_AVATAR_SELECTOR_MAIN_SIZE)) / w));
#line 94 "../src/contacts-avatar-selector.vala"
		w = CONTACTS_AVATAR_SELECTOR_MAIN_SIZE;
#line 443 "contacts-avatar-selector.c"
	} else {
#line 96 "../src/contacts-avatar-selector.vala"
		w = (gint) round ((gdouble) ((w * ((gfloat) CONTACTS_AVATAR_SELECTOR_MAIN_SIZE)) / h));
#line 97 "../src/contacts-avatar-selector.vala"
		h = CONTACTS_AVATAR_SELECTOR_MAIN_SIZE;
#line 449 "contacts-avatar-selector.c"
	}
#line 100 "../src/contacts-avatar-selector.vala"
	_tmp2_ = gdk_pixbuf_scale_simple (pixbuf, w, h, GDK_INTERP_HYPER);
#line 100 "../src/contacts-avatar-selector.vala"
	result = _tmp2_;
#line 100 "../src/contacts-avatar-selector.vala"
	return result;
#line 457 "contacts-avatar-selector.c"
}

static void
contacts_avatar_selector_selected_pixbuf (ContactsAvatarSelector* self,
                                          GdkPixbuf* pixbuf)
{
	GError* _inner_error0_ = NULL;
#line 103 "../src/contacts-avatar-selector.vala"
	g_return_if_fail (self != NULL);
#line 103 "../src/contacts-avatar-selector.vala"
	g_return_if_fail (pixbuf != NULL);
#line 469 "contacts-avatar-selector.c"
	{
		guint8* buffer = NULL;
		gint buffer_length1 = 0;
		gint _buffer_size_ = 0;
		guint8* _tmp0_ = NULL;
		gsize _tmp1_ = 0;
		GBytesIcon* icon = NULL;
		GBytes* _tmp2_;
		GBytes* _tmp3_;
		GBytesIcon* _tmp4_;
		GBytesIcon* _tmp5_;
		GBytesIcon* _tmp6_;
#line 106 "../src/contacts-avatar-selector.vala"
		gdk_pixbuf_save_to_buffer (pixbuf, &_tmp0_, &_tmp1_, "png", &_inner_error0_, NULL, NULL);
#line 106 "../src/contacts-avatar-selector.vala"
		buffer = (g_free (buffer), NULL);
#line 106 "../src/contacts-avatar-selector.vala"
		buffer = _tmp0_;
#line 106 "../src/contacts-avatar-selector.vala"
		buffer_length1 = _tmp1_;
#line 106 "../src/contacts-avatar-selector.vala"
		_buffer_size_ = buffer_length1;
#line 106 "../src/contacts-avatar-selector.vala"
		if (G_UNLIKELY (_inner_error0_ != NULL)) {
#line 106 "../src/contacts-avatar-selector.vala"
			buffer = (g_free (buffer), NULL);
#line 496 "contacts-avatar-selector.c"
			goto __catch4_g_error;
		}
#line 107 "../src/contacts-avatar-selector.vala"
		_tmp2_ = g_bytes_new (buffer, buffer_length1);
#line 107 "../src/contacts-avatar-selector.vala"
		_tmp3_ = _tmp2_;
#line 107 "../src/contacts-avatar-selector.vala"
		_tmp4_ = (GBytesIcon*) g_bytes_icon_new (_tmp3_);
#line 107 "../src/contacts-avatar-selector.vala"
		_tmp5_ = _tmp4_;
#line 107 "../src/contacts-avatar-selector.vala"
		_g_bytes_unref0 (_tmp3_);
#line 107 "../src/contacts-avatar-selector.vala"
		icon = _tmp5_;
#line 108 "../src/contacts-avatar-selector.vala"
		_tmp6_ = icon;
#line 108 "../src/contacts-avatar-selector.vala"
		g_signal_emit (self, contacts_avatar_selector_signals[CONTACTS_AVATAR_SELECTOR_SET_AVATAR_SIGNAL], 0, (GIcon*) _tmp6_);
#line 104 "../src/contacts-avatar-selector.vala"
		_g_object_unref0 (icon);
#line 104 "../src/contacts-avatar-selector.vala"
		buffer = (g_free (buffer), NULL);
#line 519 "contacts-avatar-selector.c"
	}
	goto __finally4;
	__catch4_g_error:
	{
		GError* e = NULL;
		GError* _tmp7_;
		const gchar* _tmp8_;
		GtkWidget* _tmp9_;
#line 104 "../src/contacts-avatar-selector.vala"
		e = _inner_error0_;
#line 104 "../src/contacts-avatar-selector.vala"
		_inner_error0_ = NULL;
#line 110 "../src/contacts-avatar-selector.vala"
		_tmp7_ = e;
#line 110 "../src/contacts-avatar-selector.vala"
		_tmp8_ = _tmp7_->message;
#line 110 "../src/contacts-avatar-selector.vala"
		g_warning ("contacts-avatar-selector.vala:110: Failed to set avatar: %s", _tmp8_);
#line 111 "../src/contacts-avatar-selector.vala"
		_tmp9_ = gtk_widget_get_toplevel ((GtkWidget*) self);
#line 111 "../src/contacts-avatar-selector.vala"
		contacts_utils_show_error_dialog (_ ("Failed to set avatar."), G_TYPE_CHECK_INSTANCE_TYPE (_tmp9_, gtk_window_get_type ()) ? ((GtkWindow*) _tmp9_) : NULL);
#line 104 "../src/contacts-avatar-selector.vala"
		_g_error_free0 (e);
#line 544 "contacts-avatar-selector.c"
	}
	__finally4:
#line 104 "../src/contacts-avatar-selector.vala"
	if (G_UNLIKELY (_inner_error0_ != NULL)) {
#line 104 "../src/contacts-avatar-selector.vala"
		g_critical ("file %s: line %d: uncaught error: %s (%s, %d)", __FILE__, __LINE__, _inner_error0_->message, g_quark_to_string (_inner_error0_->domain), _inner_error0_->code);
#line 104 "../src/contacts-avatar-selector.vala"
		g_clear_error (&_inner_error0_);
#line 104 "../src/contacts-avatar-selector.vala"
		return;
#line 555 "contacts-avatar-selector.c"
	}
}

static Block8Data*
block8_data_ref (Block8Data* _data8_)
{
#line 116 "../src/contacts-avatar-selector.vala"
	g_atomic_int_inc (&_data8_->_ref_count_);
#line 116 "../src/contacts-avatar-selector.vala"
	return _data8_;
#line 566 "contacts-avatar-selector.c"
}

static void
block8_data_unref (void * _userdata_)
{
	Block8Data* _data8_;
	_data8_ = (Block8Data*) _userdata_;
#line 116 "../src/contacts-avatar-selector.vala"
	if (g_atomic_int_dec_and_test (&_data8_->_ref_count_)) {
#line 576 "contacts-avatar-selector.c"
		ContactsAvatarSelector* self;
#line 116 "../src/contacts-avatar-selector.vala"
		self = _data8_->self;
#line 116 "../src/contacts-avatar-selector.vala"
		_g_object_unref0 (_data8_->source_pixbuf);
#line 116 "../src/contacts-avatar-selector.vala"
		_g_object_unref0 (self);
#line 116 "../src/contacts-avatar-selector.vala"
		g_slice_free (Block8Data, _data8_);
#line 586 "contacts-avatar-selector.c"
	}
}

static void
__lambda14_ (Block8Data* _data8_)
{
	ContactsAvatarSelector* self;
	GdkPixbuf* _tmp0_;
	GdkPixbuf* _tmp1_;
#line 124 "../src/contacts-avatar-selector.vala"
	self = _data8_->self;
#line 125 "../src/contacts-avatar-selector.vala"
	_tmp0_ = contacts_avatar_selector_scale_pixbuf_for_avatar_use (self, _data8_->source_pixbuf);
#line 125 "../src/contacts-avatar-selector.vala"
	_tmp1_ = _tmp0_;
#line 125 "../src/contacts-avatar-selector.vala"
	contacts_avatar_selector_selected_pixbuf (self, _tmp1_);
#line 125 "../src/contacts-avatar-selector.vala"
	_g_object_unref0 (_tmp1_);
#line 126 "../src/contacts-avatar-selector.vala"
	gtk_popover_popdown ((GtkPopover*) self);
#line 608 "contacts-avatar-selector.c"
}

static void
___lambda14__gtk_button_clicked (GtkButton* _sender,
                                 gpointer self)
{
#line 124 "../src/contacts-avatar-selector.vala"
	__lambda14_ (self);
#line 617 "contacts-avatar-selector.c"
}

static GtkFlowBoxChild*
contacts_avatar_selector_create_thumbnail (ContactsAvatarSelector* self,
                                           GdkPixbuf* source_pixbuf)
{
	Block8Data* _data8_;
	GdkPixbuf* _tmp0_;
	ContactsAvatar* avatar = NULL;
	ContactsAvatar* _tmp1_;
	GdkPixbuf* pixbuf = NULL;
	GdkPixbuf* _tmp2_;
	GtkButton* button = NULL;
	GtkButton* _tmp3_;
	GtkStyleContext* _tmp4_;
	GtkFlowBoxChild* child = NULL;
	GtkFlowBoxChild* _tmp5_;
	GtkFlowBoxChild* result = NULL;
#line 116 "../src/contacts-avatar-selector.vala"
	g_return_val_if_fail (self != NULL, NULL);
#line 116 "../src/contacts-avatar-selector.vala"
	g_return_val_if_fail (source_pixbuf != NULL, NULL);
#line 116 "../src/contacts-avatar-selector.vala"
	_data8_ = g_slice_new0 (Block8Data);
#line 116 "../src/contacts-avatar-selector.vala"
	_data8_->_ref_count_ = 1;
#line 116 "../src/contacts-avatar-selector.vala"
	_data8_->self = g_object_ref (self);
#line 116 "../src/contacts-avatar-selector.vala"
	_tmp0_ = _g_object_ref0 (source_pixbuf);
#line 116 "../src/contacts-avatar-selector.vala"
	_g_object_unref0 (_data8_->source_pixbuf);
#line 116 "../src/contacts-avatar-selector.vala"
	_data8_->source_pixbuf = _tmp0_;
#line 117 "../src/contacts-avatar-selector.vala"
	_tmp1_ = contacts_avatar_new (CONTACTS_AVATAR_SELECTOR_ICONS_SIZE, NULL);
#line 117 "../src/contacts-avatar-selector.vala"
	g_object_ref_sink (_tmp1_);
#line 117 "../src/contacts-avatar-selector.vala"
	avatar = _tmp1_;
#line 118 "../src/contacts-avatar-selector.vala"
	_tmp2_ = gdk_pixbuf_scale_simple (_data8_->source_pixbuf, CONTACTS_AVATAR_SELECTOR_ICONS_SIZE, CONTACTS_AVATAR_SELECTOR_ICONS_SIZE, GDK_INTERP_HYPER);
#line 118 "../src/contacts-avatar-selector.vala"
	pixbuf = _tmp2_;
#line 119 "../src/contacts-avatar-selector.vala"
	contacts_avatar_set_pixbuf (avatar, pixbuf);
#line 121 "../src/contacts-avatar-selector.vala"
	_tmp3_ = (GtkButton*) gtk_button_new ();
#line 121 "../src/contacts-avatar-selector.vala"
	g_object_ref_sink (_tmp3_);
#line 121 "../src/contacts-avatar-selector.vala"
	button = _tmp3_;
#line 122 "../src/contacts-avatar-selector.vala"
	_tmp4_ = gtk_widget_get_style_context ((GtkWidget*) button);
#line 122 "../src/contacts-avatar-selector.vala"
	gtk_style_context_add_class (_tmp4_, CONTACTS_AVATAR_SELECTOR_AVATAR_BUTTON_CSS_NAME);
#line 123 "../src/contacts-avatar-selector.vala"
	gtk_button_set_image (button, (GtkWidget*) avatar);
#line 124 "../src/contacts-avatar-selector.vala"
	g_signal_connect_data (button, "clicked", (GCallback) ___lambda14__gtk_button_clicked, block8_data_ref (_data8_), (GClosureNotify) block8_data_unref, 0);
#line 128 "../src/contacts-avatar-selector.vala"
	_tmp5_ = (GtkFlowBoxChild*) gtk_flow_box_child_new ();
#line 128 "../src/contacts-avatar-selector.vala"
	g_object_ref_sink (_tmp5_);
#line 128 "../src/contacts-avatar-selector.vala"
	child = _tmp5_;
#line 129 "../src/contacts-avatar-selector.vala"
	gtk_container_add ((GtkContainer*) child, (GtkWidget*) button);
#line 130 "../src/contacts-avatar-selector.vala"
	gtk_widget_set_halign ((GtkWidget*) child, GTK_ALIGN_START);
#line 132 "../src/contacts-avatar-selector.vala"
	result = child;
#line 132 "../src/contacts-avatar-selector.vala"
	_g_object_unref0 (button);
#line 132 "../src/contacts-avatar-selector.vala"
	_g_object_unref0 (pixbuf);
#line 132 "../src/contacts-avatar-selector.vala"
	_g_object_unref0 (avatar);
#line 132 "../src/contacts-avatar-selector.vala"
	block8_data_unref (_data8_);
#line 132 "../src/contacts-avatar-selector.vala"
	_data8_ = NULL;
#line 132 "../src/contacts-avatar-selector.vala"
	return result;
#line 702 "contacts-avatar-selector.c"
}

static GtkFlowBoxChild*
contacts_avatar_selector_thumbnail_for_persona (ContactsAvatarSelector* self,
                                                FolksPersona* persona)
{
	FolksAvatarDetails* details = NULL;
	FolksAvatarDetails* _tmp0_;
	gboolean _tmp1_ = FALSE;
	FolksAvatarDetails* _tmp2_;
	GError* _inner_error0_ = NULL;
	GtkFlowBoxChild* result = NULL;
#line 135 "../src/contacts-avatar-selector.vala"
	g_return_val_if_fail (self != NULL, NULL);
#line 135 "../src/contacts-avatar-selector.vala"
	g_return_val_if_fail (persona != NULL, NULL);
#line 136 "../src/contacts-avatar-selector.vala"
	_tmp0_ = _g_object_ref0 (G_TYPE_CHECK_INSTANCE_TYPE (persona, FOLKS_TYPE_AVATAR_DETAILS) ? ((FolksAvatarDetails*) persona) : NULL);
#line 136 "../src/contacts-avatar-selector.vala"
	details = _tmp0_;
#line 137 "../src/contacts-avatar-selector.vala"
	_tmp2_ = details;
#line 137 "../src/contacts-avatar-selector.vala"
	if (_tmp2_ == NULL) {
#line 137 "../src/contacts-avatar-selector.vala"
		_tmp1_ = TRUE;
#line 729 "contacts-avatar-selector.c"
	} else {
		FolksAvatarDetails* _tmp3_;
		GLoadableIcon* _tmp4_;
		GLoadableIcon* _tmp5_;
#line 137 "../src/contacts-avatar-selector.vala"
		_tmp3_ = details;
#line 137 "../src/contacts-avatar-selector.vala"
		_tmp4_ = folks_avatar_details_get_avatar (_tmp3_);
#line 137 "../src/contacts-avatar-selector.vala"
		_tmp5_ = _tmp4_;
#line 137 "../src/contacts-avatar-selector.vala"
		_tmp1_ = _tmp5_ == NULL;
#line 742 "contacts-avatar-selector.c"
	}
#line 137 "../src/contacts-avatar-selector.vala"
	if (_tmp1_) {
#line 138 "../src/contacts-avatar-selector.vala"
		result = NULL;
#line 138 "../src/contacts-avatar-selector.vala"
		_g_object_unref0 (details);
#line 138 "../src/contacts-avatar-selector.vala"
		return result;
#line 752 "contacts-avatar-selector.c"
	}
	{
		GInputStream* stream = NULL;
		FolksAvatarDetails* _tmp6_;
		GLoadableIcon* _tmp7_;
		GLoadableIcon* _tmp8_;
		GInputStream* _tmp9_;
		GdkPixbuf* _tmp10_ = NULL;
		GInputStream* _tmp11_;
		GdkPixbuf* _tmp12_;
		GtkFlowBoxChild* _tmp13_;
#line 141 "../src/contacts-avatar-selector.vala"
		_tmp6_ = details;
#line 141 "../src/contacts-avatar-selector.vala"
		_tmp7_ = folks_avatar_details_get_avatar (_tmp6_);
#line 141 "../src/contacts-avatar-selector.vala"
		_tmp8_ = _tmp7_;
#line 141 "../src/contacts-avatar-selector.vala"
		_tmp9_ = g_loadable_icon_load (_tmp8_, CONTACTS_AVATAR_SELECTOR_MAIN_SIZE, NULL, NULL, &_inner_error0_);
#line 141 "../src/contacts-avatar-selector.vala"
		stream = _tmp9_;
#line 141 "../src/contacts-avatar-selector.vala"
		if (G_UNLIKELY (_inner_error0_ != NULL)) {
#line 776 "contacts-avatar-selector.c"
			goto __catch5_g_error;
		}
#line 142 "../src/contacts-avatar-selector.vala"
		_tmp11_ = stream;
#line 142 "../src/contacts-avatar-selector.vala"
		_tmp12_ = gdk_pixbuf_new_from_stream (_tmp11_, NULL, &_inner_error0_);
#line 142 "../src/contacts-avatar-selector.vala"
		_tmp10_ = _tmp12_;
#line 142 "../src/contacts-avatar-selector.vala"
		if (G_UNLIKELY (_inner_error0_ != NULL)) {
#line 142 "../src/contacts-avatar-selector.vala"
			_g_object_unref0 (stream);
#line 789 "contacts-avatar-selector.c"
			goto __catch5_g_error;
		}
#line 142 "../src/contacts-avatar-selector.vala"
		_tmp13_ = contacts_avatar_selector_create_thumbnail (self, _tmp10_);
#line 142 "../src/contacts-avatar-selector.vala"
		result = _tmp13_;
#line 142 "../src/contacts-avatar-selector.vala"
		_g_object_unref0 (_tmp10_);
#line 142 "../src/contacts-avatar-selector.vala"
		_g_object_unref0 (stream);
#line 142 "../src/contacts-avatar-selector.vala"
		_g_object_unref0 (details);
#line 142 "../src/contacts-avatar-selector.vala"
		return result;
#line 804 "contacts-avatar-selector.c"
	}
	goto __finally5;
	__catch5_g_error:
	{
		const gchar* _tmp14_;
		const gchar* _tmp15_;
#line 140 "../src/contacts-avatar-selector.vala"
		g_clear_error (&_inner_error0_);
#line 140 "../src/contacts-avatar-selector.vala"
		_inner_error0_ = NULL;
#line 144 "../src/contacts-avatar-selector.vala"
		_tmp14_ = folks_persona_get_display_id (persona);
#line 144 "../src/contacts-avatar-selector.vala"
		_tmp15_ = _tmp14_;
#line 144 "../src/contacts-avatar-selector.vala"
		g_debug ("contacts-avatar-selector.vala:144: Couldn't create frame for persona \"" \
"%s\".", _tmp15_);
#line 821 "contacts-avatar-selector.c"
	}
	__finally5:
#line 140 "../src/contacts-avatar-selector.vala"
	if (G_UNLIKELY (_inner_error0_ != NULL)) {
#line 140 "../src/contacts-avatar-selector.vala"
		_g_object_unref0 (details);
#line 140 "../src/contacts-avatar-selector.vala"
		g_critical ("file %s: line %d: uncaught error: %s (%s, %d)", __FILE__, __LINE__, _inner_error0_->message, g_quark_to_string (_inner_error0_->domain), _inner_error0_->code);
#line 140 "../src/contacts-avatar-selector.vala"
		g_clear_error (&_inner_error0_);
#line 140 "../src/contacts-avatar-selector.vala"
		return NULL;
#line 834 "contacts-avatar-selector.c"
	}
#line 147 "../src/contacts-avatar-selector.vala"
	result = NULL;
#line 147 "../src/contacts-avatar-selector.vala"
	_g_object_unref0 (details);
#line 147 "../src/contacts-avatar-selector.vala"
	return result;
#line 842 "contacts-avatar-selector.c"
}

static GtkFlowBoxChild*
contacts_avatar_selector_thumbnail_for_filename (ContactsAvatarSelector* self,
                                                 const gchar* filename)
{
	GError* _inner_error0_ = NULL;
	GtkFlowBoxChild* result = NULL;
#line 150 "../src/contacts-avatar-selector.vala"
	g_return_val_if_fail (self != NULL, NULL);
#line 150 "../src/contacts-avatar-selector.vala"
	g_return_val_if_fail (filename != NULL, NULL);
#line 855 "contacts-avatar-selector.c"
	{
		GdkPixbuf* _tmp0_ = NULL;
		GdkPixbuf* _tmp1_;
		GtkFlowBoxChild* _tmp2_;
#line 152 "../src/contacts-avatar-selector.vala"
		_tmp1_ = gdk_pixbuf_new_from_file (filename, &_inner_error0_);
#line 152 "../src/contacts-avatar-selector.vala"
		_tmp0_ = _tmp1_;
#line 152 "../src/contacts-avatar-selector.vala"
		if (G_UNLIKELY (_inner_error0_ != NULL)) {
#line 866 "contacts-avatar-selector.c"
			goto __catch6_g_error;
		}
#line 152 "../src/contacts-avatar-selector.vala"
		_tmp2_ = contacts_avatar_selector_create_thumbnail (self, _tmp0_);
#line 152 "../src/contacts-avatar-selector.vala"
		result = _tmp2_;
#line 152 "../src/contacts-avatar-selector.vala"
		_g_object_unref0 (_tmp0_);
#line 152 "../src/contacts-avatar-selector.vala"
		return result;
#line 877 "contacts-avatar-selector.c"
	}
	goto __finally6;
	__catch6_g_error:
	{
#line 151 "../src/contacts-avatar-selector.vala"
		g_clear_error (&_inner_error0_);
#line 151 "../src/contacts-avatar-selector.vala"
		_inner_error0_ = NULL;
#line 154 "../src/contacts-avatar-selector.vala"
		g_debug ("contacts-avatar-selector.vala:154: Couldn't create frame for file \"%s" \
"\".", filename);
#line 888 "contacts-avatar-selector.c"
	}
	__finally6:
#line 151 "../src/contacts-avatar-selector.vala"
	if (G_UNLIKELY (_inner_error0_ != NULL)) {
#line 151 "../src/contacts-avatar-selector.vala"
		g_critical ("file %s: line %d: uncaught error: %s (%s, %d)", __FILE__, __LINE__, _inner_error0_->message, g_quark_to_string (_inner_error0_->domain), _inner_error0_->code);
#line 151 "../src/contacts-avatar-selector.vala"
		g_clear_error (&_inner_error0_);
#line 151 "../src/contacts-avatar-selector.vala"
		return NULL;
#line 899 "contacts-avatar-selector.c"
	}
#line 157 "../src/contacts-avatar-selector.vala"
	result = NULL;
#line 157 "../src/contacts-avatar-selector.vala"
	return result;
#line 905 "contacts-avatar-selector.c"
}

static void
contacts_avatar_selector_update_thumbnail_grids (ContactsAvatarSelector* self)
{
	FolksIndividual* _tmp0_;
	GtkFlowBox* _tmp13_;
	gchar** stock_files = NULL;
	gint _tmp14_ = 0;
	gchar** _tmp15_;
	gint stock_files_length1;
	gint _stock_files_size_;
	gchar** _tmp16_;
	gint _tmp16__length1;
	GtkFlowBox* _tmp23_;
#line 160 "../src/contacts-avatar-selector.vala"
	g_return_if_fail (self != NULL);
#line 161 "../src/contacts-avatar-selector.vala"
	_tmp0_ = self->priv->individual;
#line 161 "../src/contacts-avatar-selector.vala"
	if (_tmp0_ != NULL) {
#line 927 "contacts-avatar-selector.c"
		{
			GeeIterator* _p_it = NULL;
			FolksIndividual* _tmp1_;
			GeeSet* _tmp2_;
			GeeSet* _tmp3_;
			GeeIterator* _tmp4_;
#line 162 "../src/contacts-avatar-selector.vala"
			_tmp1_ = self->priv->individual;
#line 162 "../src/contacts-avatar-selector.vala"
			_tmp2_ = folks_individual_get_personas (_tmp1_);
#line 162 "../src/contacts-avatar-selector.vala"
			_tmp3_ = _tmp2_;
#line 162 "../src/contacts-avatar-selector.vala"
			_tmp4_ = gee_iterable_iterator ((GeeIterable*) _tmp3_);
#line 162 "../src/contacts-avatar-selector.vala"
			_p_it = _tmp4_;
#line 162 "../src/contacts-avatar-selector.vala"
			while (TRUE) {
#line 946 "contacts-avatar-selector.c"
				GeeIterator* _tmp5_;
				FolksPersona* p = NULL;
				GeeIterator* _tmp6_;
				gpointer _tmp7_;
				GtkFlowBoxChild* button = NULL;
				FolksPersona* _tmp8_;
				GtkFlowBoxChild* _tmp9_;
				GtkFlowBoxChild* _tmp10_;
#line 162 "../src/contacts-avatar-selector.vala"
				_tmp5_ = _p_it;
#line 162 "../src/contacts-avatar-selector.vala"
				if (!gee_iterator_next (_tmp5_)) {
#line 162 "../src/contacts-avatar-selector.vala"
					break;
#line 961 "contacts-avatar-selector.c"
				}
#line 162 "../src/contacts-avatar-selector.vala"
				_tmp6_ = _p_it;
#line 162 "../src/contacts-avatar-selector.vala"
				_tmp7_ = gee_iterator_get (_tmp6_);
#line 162 "../src/contacts-avatar-selector.vala"
				p = (FolksPersona*) _tmp7_;
#line 163 "../src/contacts-avatar-selector.vala"
				_tmp8_ = p;
#line 163 "../src/contacts-avatar-selector.vala"
				_tmp9_ = contacts_avatar_selector_thumbnail_for_persona (self, _tmp8_);
#line 163 "../src/contacts-avatar-selector.vala"
				button = _tmp9_;
#line 164 "../src/contacts-avatar-selector.vala"
				_tmp10_ = button;
#line 164 "../src/contacts-avatar-selector.vala"
				if (_tmp10_ != NULL) {
#line 979 "contacts-avatar-selector.c"
					GtkFlowBox* _tmp11_;
					GtkFlowBoxChild* _tmp12_;
#line 165 "../src/contacts-avatar-selector.vala"
					_tmp11_ = self->priv->personas_thumbnail_grid;
#line 165 "../src/contacts-avatar-selector.vala"
					_tmp12_ = button;
#line 165 "../src/contacts-avatar-selector.vala"
					gtk_container_add ((GtkContainer*) _tmp11_, (GtkWidget*) _tmp12_);
#line 988 "contacts-avatar-selector.c"
				}
#line 162 "../src/contacts-avatar-selector.vala"
				_g_object_unref0 (button);
#line 162 "../src/contacts-avatar-selector.vala"
				_g_object_unref0 (p);
#line 994 "contacts-avatar-selector.c"
			}
#line 162 "../src/contacts-avatar-selector.vala"
			_g_object_unref0 (_p_it);
#line 998 "contacts-avatar-selector.c"
		}
	}
#line 168 "../src/contacts-avatar-selector.vala"
	_tmp13_ = self->priv->personas_thumbnail_grid;
#line 168 "../src/contacts-avatar-selector.vala"
	gtk_widget_show_all ((GtkWidget*) _tmp13_);
#line 170 "../src/contacts-avatar-selector.vala"
	_tmp15_ = contacts_utils_get_stock_avatars (&_tmp14_);
#line 170 "../src/contacts-avatar-selector.vala"
	stock_files = _tmp15_;
#line 170 "../src/contacts-avatar-selector.vala"
	stock_files_length1 = _tmp14_;
#line 170 "../src/contacts-avatar-selector.vala"
	_stock_files_size_ = stock_files_length1;
#line 171 "../src/contacts-avatar-selector.vala"
	_tmp16_ = stock_files;
#line 171 "../src/contacts-avatar-selector.vala"
	_tmp16__length1 = stock_files_length1;
#line 1017 "contacts-avatar-selector.c"
	{
		gchar** file_name_collection = NULL;
		gint file_name_collection_length1 = 0;
		gint _file_name_collection_size_ = 0;
		gint file_name_it = 0;
#line 171 "../src/contacts-avatar-selector.vala"
		file_name_collection = _tmp16_;
#line 171 "../src/contacts-avatar-selector.vala"
		file_name_collection_length1 = _tmp16__length1;
#line 171 "../src/contacts-avatar-selector.vala"
		for (file_name_it = 0; file_name_it < file_name_collection_length1; file_name_it = file_name_it + 1) {
#line 1029 "contacts-avatar-selector.c"
			gchar* _tmp17_;
			gchar* file_name = NULL;
#line 171 "../src/contacts-avatar-selector.vala"
			_tmp17_ = g_strdup (file_name_collection[file_name_it]);
#line 171 "../src/contacts-avatar-selector.vala"
			file_name = _tmp17_;
#line 1036 "contacts-avatar-selector.c"
			{
				GtkFlowBoxChild* button = NULL;
				const gchar* _tmp18_;
				GtkFlowBoxChild* _tmp19_;
				GtkFlowBoxChild* _tmp20_;
#line 172 "../src/contacts-avatar-selector.vala"
				_tmp18_ = file_name;
#line 172 "../src/contacts-avatar-selector.vala"
				_tmp19_ = contacts_avatar_selector_thumbnail_for_filename (self, _tmp18_);
#line 172 "../src/contacts-avatar-selector.vala"
				button = _tmp19_;
#line 173 "../src/contacts-avatar-selector.vala"
				_tmp20_ = button;
#line 173 "../src/contacts-avatar-selector.vala"
				if (_tmp20_ != NULL) {
#line 1052 "contacts-avatar-selector.c"
					GtkFlowBox* _tmp21_;
					GtkFlowBoxChild* _tmp22_;
#line 174 "../src/contacts-avatar-selector.vala"
					_tmp21_ = self->priv->stock_thumbnail_grid;
#line 174 "../src/contacts-avatar-selector.vala"
					_tmp22_ = button;
#line 174 "../src/contacts-avatar-selector.vala"
					gtk_container_add ((GtkContainer*) _tmp21_, (GtkWidget*) _tmp22_);
#line 1061 "contacts-avatar-selector.c"
				}
#line 171 "../src/contacts-avatar-selector.vala"
				_g_object_unref0 (button);
#line 171 "../src/contacts-avatar-selector.vala"
				_g_free0 (file_name);
#line 1067 "contacts-avatar-selector.c"
			}
		}
	}
#line 176 "../src/contacts-avatar-selector.vala"
	_tmp23_ = self->priv->stock_thumbnail_grid;
#line 176 "../src/contacts-avatar-selector.vala"
	gtk_widget_show_all ((GtkWidget*) _tmp23_);
#line 160 "../src/contacts-avatar-selector.vala"
	stock_files = (_vala_array_free (stock_files, stock_files_length1, (GDestroyNotify) g_free), NULL);
#line 1077 "contacts-avatar-selector.c"
}

static void
__lambda19_ (ContactsAvatarSelector* self,
             GdkPixbuf* pix)
{
	GdkPixbuf* _tmp0_;
	GdkPixbuf* _tmp1_;
#line 183 "../src/contacts-avatar-selector.vala"
	g_return_if_fail (pix != NULL);
#line 184 "../src/contacts-avatar-selector.vala"
	_tmp0_ = contacts_avatar_selector_scale_pixbuf_for_avatar_use (self, pix);
#line 184 "../src/contacts-avatar-selector.vala"
	_tmp1_ = _tmp0_;
#line 184 "../src/contacts-avatar-selector.vala"
	contacts_avatar_selector_selected_pixbuf (self, _tmp1_);
#line 184 "../src/contacts-avatar-selector.vala"
	_g_object_unref0 (_tmp1_);
#line 1096 "contacts-avatar-selector.c"
}

static void
___lambda19__contacts_crop_cheese_dialog_picture_selected (ContactsCropCheeseDialog* _sender,
                                                           GdkPixbuf* buf,
                                                           gpointer self)
{
#line 183 "../src/contacts-avatar-selector.vala"
	__lambda19_ ((ContactsAvatarSelector*) self, buf);
#line 1106 "contacts-avatar-selector.c"
}

static void
contacts_avatar_selector_on_cheese_clicked (ContactsAvatarSelector* self,
                                            GtkButton* button)
{
	ContactsCropCheeseDialog* dialog = NULL;
	GtkWidget* _tmp0_;
	ContactsCropCheeseDialog* _tmp1_;
#line 180 "../src/contacts-avatar-selector.vala"
	g_return_if_fail (self != NULL);
#line 180 "../src/contacts-avatar-selector.vala"
	g_return_if_fail (button != NULL);
#line 181 "../src/contacts-avatar-selector.vala"
	_tmp0_ = gtk_widget_get_toplevel ((GtkWidget*) self);
#line 181 "../src/contacts-avatar-selector.vala"
	_tmp1_ = contacts_crop_cheese_dialog_new_for_cheese ((GtkWindow*) G_TYPE_CHECK_INSTANCE_CAST (_tmp0_, CONTACTS_TYPE_WINDOW, ContactsWindow));
#line 181 "../src/contacts-avatar-selector.vala"
	g_object_ref_sink (_tmp1_);
#line 181 "../src/contacts-avatar-selector.vala"
	dialog = _tmp1_;
#line 182 "../src/contacts-avatar-selector.vala"
	gtk_widget_show_all ((GtkWidget*) dialog);
#line 183 "../src/contacts-avatar-selector.vala"
	g_signal_connect_object (dialog, "picture-selected", (GCallback) ___lambda19__contacts_crop_cheese_dialog_picture_selected, self, 0);
#line 186 "../src/contacts-avatar-selector.vala"
	gtk_popover_popdown ((GtkPopover*) self);
#line 180 "../src/contacts-avatar-selector.vala"
	_g_object_unref0 (dialog);
#line 1136 "contacts-avatar-selector.c"
}

static void
_contacts_avatar_selector_on_cheese_clicked_gtk_button_clicked (GtkButton* _sender,
                                                                gpointer self)
{
#line 30 "../src/contacts-avatar-selector.vala"
	contacts_avatar_selector_on_cheese_clicked ((ContactsAvatarSelector*) self, _sender);
#line 1145 "contacts-avatar-selector.c"
}

static Block9Data*
block9_data_ref (Block9Data* _data9_)
{
#line 190 "../src/contacts-avatar-selector.vala"
	g_atomic_int_inc (&_data9_->_ref_count_);
#line 190 "../src/contacts-avatar-selector.vala"
	return _data9_;
#line 1155 "contacts-avatar-selector.c"
}

static void
block9_data_unref (void * _userdata_)
{
	Block9Data* _data9_;
	_data9_ = (Block9Data*) _userdata_;
#line 190 "../src/contacts-avatar-selector.vala"
	if (g_atomic_int_dec_and_test (&_data9_->_ref_count_)) {
#line 1165 "contacts-avatar-selector.c"
		ContactsAvatarSelector* self;
#line 190 "../src/contacts-avatar-selector.vala"
		self = _data9_->self;
#line 190 "../src/contacts-avatar-selector.vala"
		_g_object_unref0 (_data9_->chooser);
#line 190 "../src/contacts-avatar-selector.vala"
		_g_object_unref0 (self);
#line 190 "../src/contacts-avatar-selector.vala"
		g_slice_free (Block9Data, _data9_);
#line 1175 "contacts-avatar-selector.c"
	}
}

static void
_contacts_avatar_selector_update_preview_gtk_file_chooser_update_preview (GtkFileChooser* _sender,
                                                                          gpointer self)
{
#line 203 "../src/contacts-avatar-selector.vala"
	contacts_avatar_selector_update_preview ((ContactsAvatarSelector*) self, _sender);
#line 1185 "contacts-avatar-selector.c"
}

static void
____lambda21_ (ContactsAvatarSelector* self,
               GdkPixbuf* pix)
{
	GdkPixbuf* _tmp0_;
	GdkPixbuf* _tmp1_;
#line 222 "../src/contacts-avatar-selector.vala"
	g_return_if_fail (pix != NULL);
#line 223 "../src/contacts-avatar-selector.vala"
	_tmp0_ = contacts_avatar_selector_scale_pixbuf_for_avatar_use (self, pix);
#line 223 "../src/contacts-avatar-selector.vala"
	_tmp1_ = _tmp0_;
#line 223 "../src/contacts-avatar-selector.vala"
	contacts_avatar_selector_selected_pixbuf (self, _tmp1_);
#line 223 "../src/contacts-avatar-selector.vala"
	_g_object_unref0 (_tmp1_);
#line 1204 "contacts-avatar-selector.c"
}

static void
_____lambda21__contacts_crop_cheese_dialog_picture_selected (ContactsCropCheeseDialog* _sender,
                                                             GdkPixbuf* buf,
                                                             gpointer self)
{
#line 222 "../src/contacts-avatar-selector.vala"
	____lambda21_ ((ContactsAvatarSelector*) self, buf);
#line 1214 "contacts-avatar-selector.c"
}

static void
__lambda20_ (Block9Data* _data9_,
             gint response)
{
	ContactsAvatarSelector* self;
	GtkFileChooserNative* _tmp25_;
	GError* _inner_error0_ = NULL;
#line 209 "../src/contacts-avatar-selector.vala"
	self = _data9_->self;
#line 210 "../src/contacts-avatar-selector.vala"
	if (response != ((gint) GTK_RESPONSE_ACCEPT)) {
#line 1228 "contacts-avatar-selector.c"
		GtkFileChooserNative* _tmp0_;
#line 211 "../src/contacts-avatar-selector.vala"
		_tmp0_ = _data9_->chooser;
#line 211 "../src/contacts-avatar-selector.vala"
		gtk_native_dialog_destroy ((GtkNativeDialog*) _tmp0_);
#line 212 "../src/contacts-avatar-selector.vala"
		return;
#line 1236 "contacts-avatar-selector.c"
	}
	{
		GFile* file = NULL;
		GtkFileChooserNative* _tmp1_;
		gchar* _tmp2_;
		gchar* _tmp3_;
		GFile* _tmp4_;
		GFile* _tmp5_;
		GFileInputStream* in_stream = NULL;
		GFile* _tmp6_;
		GFileInputStream* _tmp7_;
		GdkPixbuf* pixbuf = NULL;
		GFileInputStream* _tmp8_;
		GdkPixbuf* _tmp9_;
		GFileInputStream* _tmp10_;
		gboolean _tmp11_ = FALSE;
		GdkPixbuf* _tmp12_;
#line 215 "../src/contacts-avatar-selector.vala"
		_tmp1_ = _data9_->chooser;
#line 215 "../src/contacts-avatar-selector.vala"
		_tmp2_ = gtk_file_chooser_get_uri ((GtkFileChooser*) _tmp1_);
#line 215 "../src/contacts-avatar-selector.vala"
		_tmp3_ = _tmp2_;
#line 215 "../src/contacts-avatar-selector.vala"
		_tmp4_ = g_file_new_for_uri (_tmp3_);
#line 215 "../src/contacts-avatar-selector.vala"
		_tmp5_ = _tmp4_;
#line 215 "../src/contacts-avatar-selector.vala"
		_g_free0 (_tmp3_);
#line 215 "../src/contacts-avatar-selector.vala"
		file = _tmp5_;
#line 216 "../src/contacts-avatar-selector.vala"
		_tmp6_ = file;
#line 216 "../src/contacts-avatar-selector.vala"
		_tmp7_ = g_file_read (_tmp6_, NULL, &_inner_error0_);
#line 216 "../src/contacts-avatar-selector.vala"
		in_stream = _tmp7_;
#line 216 "../src/contacts-avatar-selector.vala"
		if (G_UNLIKELY (_inner_error0_ != NULL)) {
#line 216 "../src/contacts-avatar-selector.vala"
			_g_object_unref0 (file);
#line 1278 "contacts-avatar-selector.c"
			goto __catch7_g_error;
		}
#line 217 "../src/contacts-avatar-selector.vala"
		_tmp8_ = in_stream;
#line 217 "../src/contacts-avatar-selector.vala"
		_tmp9_ = gdk_pixbuf_new_from_stream ((GInputStream*) _tmp8_, NULL, &_inner_error0_);
#line 217 "../src/contacts-avatar-selector.vala"
		pixbuf = _tmp9_;
#line 217 "../src/contacts-avatar-selector.vala"
		if (G_UNLIKELY (_inner_error0_ != NULL)) {
#line 217 "../src/contacts-avatar-selector.vala"
			_g_object_unref0 (in_stream);
#line 217 "../src/contacts-avatar-selector.vala"
			_g_object_unref0 (file);
#line 1293 "contacts-avatar-selector.c"
			goto __catch7_g_error;
		}
#line 218 "../src/contacts-avatar-selector.vala"
		_tmp10_ = in_stream;
#line 218 "../src/contacts-avatar-selector.vala"
		g_input_stream_close ((GInputStream*) _tmp10_, NULL, &_inner_error0_);
#line 218 "../src/contacts-avatar-selector.vala"
		if (G_UNLIKELY (_inner_error0_ != NULL)) {
#line 218 "../src/contacts-avatar-selector.vala"
			_g_object_unref0 (pixbuf);
#line 218 "../src/contacts-avatar-selector.vala"
			_g_object_unref0 (in_stream);
#line 218 "../src/contacts-avatar-selector.vala"
			_g_object_unref0 (file);
#line 1308 "contacts-avatar-selector.c"
			goto __catch7_g_error;
		}
#line 219 "../src/contacts-avatar-selector.vala"
		_tmp12_ = pixbuf;
#line 219 "../src/contacts-avatar-selector.vala"
		if (gdk_pixbuf_get_width (_tmp12_) > CONTACTS_AVATAR_SELECTOR_MAIN_SIZE) {
#line 219 "../src/contacts-avatar-selector.vala"
			_tmp11_ = TRUE;
#line 1317 "contacts-avatar-selector.c"
		} else {
			GdkPixbuf* _tmp13_;
#line 219 "../src/contacts-avatar-selector.vala"
			_tmp13_ = pixbuf;
#line 219 "../src/contacts-avatar-selector.vala"
			_tmp11_ = gdk_pixbuf_get_height (_tmp13_) > CONTACTS_AVATAR_SELECTOR_MAIN_SIZE;
#line 1324 "contacts-avatar-selector.c"
		}
#line 219 "../src/contacts-avatar-selector.vala"
		if (_tmp11_) {
#line 1328 "contacts-avatar-selector.c"
			ContactsCropCheeseDialog* dialog = NULL;
			GtkWidget* _tmp14_;
			GdkPixbuf* _tmp15_;
			ContactsCropCheeseDialog* _tmp16_;
			ContactsCropCheeseDialog* _tmp17_;
			ContactsCropCheeseDialog* _tmp18_;
#line 220 "../src/contacts-avatar-selector.vala"
			_tmp14_ = gtk_widget_get_toplevel ((GtkWidget*) self);
#line 220 "../src/contacts-avatar-selector.vala"
			_tmp15_ = pixbuf;
#line 220 "../src/contacts-avatar-selector.vala"
			_tmp16_ = contacts_crop_cheese_dialog_new_for_crop ((GtkWindow*) G_TYPE_CHECK_INSTANCE_CAST (_tmp14_, CONTACTS_TYPE_WINDOW, ContactsWindow), _tmp15_);
#line 220 "../src/contacts-avatar-selector.vala"
			g_object_ref_sink (_tmp16_);
#line 220 "../src/contacts-avatar-selector.vala"
			dialog = _tmp16_;
#line 222 "../src/contacts-avatar-selector.vala"
			_tmp17_ = dialog;
#line 222 "../src/contacts-avatar-selector.vala"
			g_signal_connect_object (_tmp17_, "picture-selected", (GCallback) _____lambda21__contacts_crop_cheese_dialog_picture_selected, self, 0);
#line 225 "../src/contacts-avatar-selector.vala"
			_tmp18_ = dialog;
#line 225 "../src/contacts-avatar-selector.vala"
			gtk_widget_show_all ((GtkWidget*) _tmp18_);
#line 219 "../src/contacts-avatar-selector.vala"
			_g_object_unref0 (dialog);
#line 1355 "contacts-avatar-selector.c"
		} else {
			GdkPixbuf* _tmp19_;
			GdkPixbuf* _tmp20_;
			GdkPixbuf* _tmp21_;
#line 227 "../src/contacts-avatar-selector.vala"
			_tmp19_ = pixbuf;
#line 227 "../src/contacts-avatar-selector.vala"
			_tmp20_ = contacts_avatar_selector_scale_pixbuf_for_avatar_use (self, _tmp19_);
#line 227 "../src/contacts-avatar-selector.vala"
			_tmp21_ = _tmp20_;
#line 227 "../src/contacts-avatar-selector.vala"
			contacts_avatar_selector_selected_pixbuf (self, _tmp21_);
#line 227 "../src/contacts-avatar-selector.vala"
			_g_object_unref0 (_tmp21_);
#line 1370 "contacts-avatar-selector.c"
		}
#line 214 "../src/contacts-avatar-selector.vala"
		_g_object_unref0 (pixbuf);
#line 214 "../src/contacts-avatar-selector.vala"
		_g_object_unref0 (in_stream);
#line 214 "../src/contacts-avatar-selector.vala"
		_g_object_unref0 (file);
#line 1378 "contacts-avatar-selector.c"
	}
	goto __finally7;
	__catch7_g_error:
	{
		GError* e = NULL;
		GError* _tmp22_;
		const gchar* _tmp23_;
		GtkWidget* _tmp24_;
#line 214 "../src/contacts-avatar-selector.vala"
		e = _inner_error0_;
#line 214 "../src/contacts-avatar-selector.vala"
		_inner_error0_ = NULL;
#line 230 "../src/contacts-avatar-selector.vala"
		_tmp22_ = e;
#line 230 "../src/contacts-avatar-selector.vala"
		_tmp23_ = _tmp22_->message;
#line 230 "../src/contacts-avatar-selector.vala"
		g_warning ("contacts-avatar-selector.vala:230: Failed to set avatar: %s", _tmp23_);
#line 231 "../src/contacts-avatar-selector.vala"
		_tmp24_ = gtk_widget_get_toplevel ((GtkWidget*) self);
#line 231 "../src/contacts-avatar-selector.vala"
		contacts_utils_show_error_dialog (_ ("Failed to set avatar."), G_TYPE_CHECK_INSTANCE_TYPE (_tmp24_, gtk_window_get_type ()) ? ((GtkWindow*) _tmp24_) : NULL);
#line 214 "../src/contacts-avatar-selector.vala"
		_g_error_free0 (e);
#line 1403 "contacts-avatar-selector.c"
	}
	__finally7:
#line 214 "../src/contacts-avatar-selector.vala"
	if (G_UNLIKELY (_inner_error0_ != NULL)) {
#line 214 "../src/contacts-avatar-selector.vala"
		g_critical ("file %s: line %d: uncaught error: %s (%s, %d)", __FILE__, __LINE__, _inner_error0_->message, g_quark_to_string (_inner_error0_->domain), _inner_error0_->code);
#line 214 "../src/contacts-avatar-selector.vala"
		g_clear_error (&_inner_error0_);
#line 214 "../src/contacts-avatar-selector.vala"
		return;
#line 1414 "contacts-avatar-selector.c"
	}
#line 235 "../src/contacts-avatar-selector.vala"
	_tmp25_ = _data9_->chooser;
#line 235 "../src/contacts-avatar-selector.vala"
	gtk_native_dialog_destroy ((GtkNativeDialog*) _tmp25_);
#line 1420 "contacts-avatar-selector.c"
}

static void
___lambda20__gtk_native_dialog_response (GtkNativeDialog* _sender,
                                         gint response_id,
                                         gpointer self)
{
#line 209 "../src/contacts-avatar-selector.vala"
	__lambda20_ (self, response_id);
#line 1430 "contacts-avatar-selector.c"
}

static void
contacts_avatar_selector_on_file_clicked (ContactsAvatarSelector* self,
                                          GtkButton* button)
{
	Block9Data* _data9_;
	GtkWidget* _tmp0_;
	GtkFileChooserNative* _tmp1_;
	GtkFileChooserNative* _tmp2_;
	GtkFileChooserNative* _tmp3_;
	GtkImage* preview = NULL;
	GtkImage* _tmp4_;
	GtkImage* _tmp5_;
	GtkFileChooserNative* _tmp6_;
	GtkImage* _tmp7_;
	GtkFileChooserNative* _tmp8_;
	GtkImage* _tmp9_;
	GtkFileChooserNative* _tmp10_;
	gchar* folder = NULL;
	const gchar* _tmp11_;
	gchar* _tmp12_;
	const gchar* _tmp13_;
	GtkFileChooserNative* _tmp16_;
	GtkFileChooserNative* _tmp17_;
#line 190 "../src/contacts-avatar-selector.vala"
	g_return_if_fail (self != NULL);
#line 190 "../src/contacts-avatar-selector.vala"
	g_return_if_fail (button != NULL);
#line 190 "../src/contacts-avatar-selector.vala"
	_data9_ = g_slice_new0 (Block9Data);
#line 190 "../src/contacts-avatar-selector.vala"
	_data9_->_ref_count_ = 1;
#line 190 "../src/contacts-avatar-selector.vala"
	_data9_->self = g_object_ref (self);
#line 191 "../src/contacts-avatar-selector.vala"
	_tmp0_ = gtk_widget_get_toplevel ((GtkWidget*) self);
#line 191 "../src/contacts-avatar-selector.vala"
	_tmp1_ = gtk_file_chooser_native_new (_ ("Browse for more pictures"), G_TYPE_CHECK_INSTANCE_CAST (_tmp0_, gtk_window_get_type (), GtkWindow), GTK_FILE_CHOOSER_ACTION_OPEN, _ ("_Open"), _ ("_Cancel"));
#line 191 "../src/contacts-avatar-selector.vala"
	_data9_->chooser = _tmp1_;
#line 195 "../src/contacts-avatar-selector.vala"
	_tmp2_ = _data9_->chooser;
#line 195 "../src/contacts-avatar-selector.vala"
	gtk_native_dialog_set_modal ((GtkNativeDialog*) _tmp2_, TRUE);
#line 196 "../src/contacts-avatar-selector.vala"
	_tmp3_ = _data9_->chooser;
#line 196 "../src/contacts-avatar-selector.vala"
	gtk_file_chooser_set_local_only ((GtkFileChooser*) _tmp3_, FALSE);
#line 197 "../src/contacts-avatar-selector.vala"
	_tmp4_ = (GtkImage*) gtk_image_new ();
#line 197 "../src/contacts-avatar-selector.vala"
	g_object_ref_sink (_tmp4_);
#line 197 "../src/contacts-avatar-selector.vala"
	preview = _tmp4_;
#line 198 "../src/contacts-avatar-selector.vala"
	_tmp5_ = preview;
#line 198 "../src/contacts-avatar-selector.vala"
	gtk_widget_set_size_request ((GtkWidget*) _tmp5_, CONTACTS_AVATAR_SELECTOR_MAIN_SIZE, -1);
#line 199 "../src/contacts-avatar-selector.vala"
	_tmp6_ = _data9_->chooser;
#line 199 "../src/contacts-avatar-selector.vala"
	_tmp7_ = preview;
#line 199 "../src/contacts-avatar-selector.vala"
	gtk_file_chooser_set_preview_widget ((GtkFileChooser*) _tmp6_, (GtkWidget*) _tmp7_);
#line 200 "../src/contacts-avatar-selector.vala"
	_tmp8_ = _data9_->chooser;
#line 200 "../src/contacts-avatar-selector.vala"
	gtk_file_chooser_set_use_preview_label ((GtkFileChooser*) _tmp8_, FALSE);
#line 201 "../src/contacts-avatar-selector.vala"
	_tmp9_ = preview;
#line 201 "../src/contacts-avatar-selector.vala"
	gtk_widget_show ((GtkWidget*) _tmp9_);
#line 203 "../src/contacts-avatar-selector.vala"
	_tmp10_ = _data9_->chooser;
#line 203 "../src/contacts-avatar-selector.vala"
	g_signal_connect_object ((GtkFileChooser*) _tmp10_, "update-preview", (GCallback) _contacts_avatar_selector_update_preview_gtk_file_chooser_update_preview, self, 0);
#line 205 "../src/contacts-avatar-selector.vala"
	_tmp11_ = g_get_user_special_dir (G_USER_DIRECTORY_PICTURES);
#line 205 "../src/contacts-avatar-selector.vala"
	_tmp12_ = g_strdup (_tmp11_);
#line 205 "../src/contacts-avatar-selector.vala"
	folder = _tmp12_;
#line 206 "../src/contacts-avatar-selector.vala"
	_tmp13_ = folder;
#line 206 "../src/contacts-avatar-selector.vala"
	if (_tmp13_ != NULL) {
#line 1518 "contacts-avatar-selector.c"
		GtkFileChooserNative* _tmp14_;
		const gchar* _tmp15_;
#line 207 "../src/contacts-avatar-selector.vala"
		_tmp14_ = _data9_->chooser;
#line 207 "../src/contacts-avatar-selector.vala"
		_tmp15_ = folder;
#line 207 "../src/contacts-avatar-selector.vala"
		gtk_file_chooser_set_current_folder ((GtkFileChooser*) _tmp14_, _tmp15_);
#line 1527 "contacts-avatar-selector.c"
	}
#line 209 "../src/contacts-avatar-selector.vala"
	_tmp16_ = _data9_->chooser;
#line 209 "../src/contacts-avatar-selector.vala"
	g_signal_connect_data ((GtkNativeDialog*) _tmp16_, "response", (GCallback) ___lambda20__gtk_native_dialog_response, block9_data_ref (_data9_), (GClosureNotify) block9_data_unref, 0);
#line 238 "../src/contacts-avatar-selector.vala"
	_tmp17_ = _data9_->chooser;
#line 238 "../src/contacts-avatar-selector.vala"
	gtk_native_dialog_run ((GtkNativeDialog*) _tmp17_);
#line 239 "../src/contacts-avatar-selector.vala"
	gtk_popover_popdown ((GtkPopover*) self);
#line 190 "../src/contacts-avatar-selector.vala"
	_g_free0 (folder);
#line 190 "../src/contacts-avatar-selector.vala"
	_g_object_unref0 (preview);
#line 190 "../src/contacts-avatar-selector.vala"
	block9_data_unref (_data9_);
#line 190 "../src/contacts-avatar-selector.vala"
	_data9_ = NULL;
#line 1547 "contacts-avatar-selector.c"
}

static void
_contacts_avatar_selector_on_file_clicked_gtk_button_clicked (GtkButton* _sender,
                                                              gpointer self)
{
#line 30 "../src/contacts-avatar-selector.vala"
	contacts_avatar_selector_on_file_clicked ((ContactsAvatarSelector*) self, _sender);
#line 1556 "contacts-avatar-selector.c"
}

static void
contacts_avatar_selector_update_preview (ContactsAvatarSelector* self,
                                         GtkFileChooser* chooser)
{
	gchar* uri = NULL;
	gchar* _tmp0_;
	const gchar* _tmp1_;
	GError* _inner_error0_ = NULL;
#line 242 "../src/contacts-avatar-selector.vala"
	g_return_if_fail (self != NULL);
#line 242 "../src/contacts-avatar-selector.vala"
	g_return_if_fail (chooser != NULL);
#line 243 "../src/contacts-avatar-selector.vala"
	_tmp0_ = gtk_file_chooser_get_preview_uri (chooser);
#line 243 "../src/contacts-avatar-selector.vala"
	uri = _tmp0_;
#line 244 "../src/contacts-avatar-selector.vala"
	_tmp1_ = uri;
#line 244 "../src/contacts-avatar-selector.vala"
	if (_tmp1_ != NULL) {
#line 1579 "contacts-avatar-selector.c"
		GdkPixbuf* pixbuf = NULL;
		GtkImage* preview = NULL;
		GtkWidget* _tmp2_;
		GtkImage* _tmp3_;
		GFile* file = NULL;
		const gchar* _tmp4_;
		GFile* _tmp5_;
		GdkPixbuf* _tmp19_;
#line 245 "../src/contacts-avatar-selector.vala"
		pixbuf = NULL;
#line 247 "../src/contacts-avatar-selector.vala"
		_tmp2_ = gtk_file_chooser_get_preview_widget (chooser);
#line 247 "../src/contacts-avatar-selector.vala"
		_tmp3_ = _g_object_ref0 (G_TYPE_CHECK_INSTANCE_TYPE (_tmp2_, gtk_image_get_type ()) ? ((GtkImage*) _tmp2_) : NULL);
#line 247 "../src/contacts-avatar-selector.vala"
		preview = _tmp3_;
#line 249 "../src/contacts-avatar-selector.vala"
		_tmp4_ = uri;
#line 249 "../src/contacts-avatar-selector.vala"
		_tmp5_ = g_file_new_for_uri (_tmp4_);
#line 249 "../src/contacts-avatar-selector.vala"
		file = _tmp5_;
#line 1602 "contacts-avatar-selector.c"
		{
			GFileInfo* file_info = NULL;
			GFile* _tmp6_;
			GFileInfo* _tmp7_;
			GFileInfo* _tmp8_;
#line 251 "../src/contacts-avatar-selector.vala"
			_tmp6_ = file;
#line 251 "../src/contacts-avatar-selector.vala"
			_tmp7_ = g_file_query_info (_tmp6_, G_FILE_ATTRIBUTE_STANDARD_CONTENT_TYPE, G_FILE_QUERY_INFO_NONE, NULL, &_inner_error0_);
#line 251 "../src/contacts-avatar-selector.vala"
			file_info = _tmp7_;
#line 251 "../src/contacts-avatar-selector.vala"
			if (G_UNLIKELY (_inner_error0_ != NULL)) {
#line 1616 "contacts-avatar-selector.c"
				goto __catch8_g_error;
			}
#line 253 "../src/contacts-avatar-selector.vala"
			_tmp8_ = file_info;
#line 253 "../src/contacts-avatar-selector.vala"
			if (_tmp8_ != NULL) {
#line 1623 "contacts-avatar-selector.c"
				gchar* mime_type = NULL;
				GFileInfo* _tmp9_;
				const gchar* _tmp10_;
				gchar* _tmp11_;
				const gchar* _tmp12_;
#line 254 "../src/contacts-avatar-selector.vala"
				_tmp9_ = file_info;
#line 254 "../src/contacts-avatar-selector.vala"
				_tmp10_ = g_file_info_get_content_type (_tmp9_);
#line 254 "../src/contacts-avatar-selector.vala"
				_tmp11_ = g_strdup (_tmp10_);
#line 254 "../src/contacts-avatar-selector.vala"
				mime_type = _tmp11_;
#line 256 "../src/contacts-avatar-selector.vala"
				_tmp12_ = mime_type;
#line 256 "../src/contacts-avatar-selector.vala"
				if (_tmp12_ != NULL) {
#line 1641 "contacts-avatar-selector.c"
					GnomeDesktopThumbnailFactory* _tmp13_;
					const gchar* _tmp14_;
					const gchar* _tmp15_;
					GdkPixbuf* _tmp16_;
					GdkPixbuf* _tmp17_;
#line 257 "../src/contacts-avatar-selector.vala"
					_tmp13_ = self->priv->thumbnail_factory;
#line 257 "../src/contacts-avatar-selector.vala"
					_tmp14_ = uri;
#line 257 "../src/contacts-avatar-selector.vala"
					_tmp15_ = mime_type;
#line 257 "../src/contacts-avatar-selector.vala"
					_tmp16_ = gnome_desktop_thumbnail_factory_generate_thumbnail (_tmp13_, _tmp14_, _tmp15_);
#line 257 "../src/contacts-avatar-selector.vala"
					_tmp17_ = _g_object_ref0 (_tmp16_);
#line 257 "../src/contacts-avatar-selector.vala"
					_g_object_unref0 (pixbuf);
#line 257 "../src/contacts-avatar-selector.vala"
					pixbuf = _tmp17_;
#line 1661 "contacts-avatar-selector.c"
				}
#line 253 "../src/contacts-avatar-selector.vala"
				_g_free0 (mime_type);
#line 1665 "contacts-avatar-selector.c"
			}
#line 250 "../src/contacts-avatar-selector.vala"
			_g_object_unref0 (file_info);
#line 1669 "contacts-avatar-selector.c"
		}
		goto __finally8;
		__catch8_g_error:
		{
#line 250 "../src/contacts-avatar-selector.vala"
			g_clear_error (&_inner_error0_);
#line 250 "../src/contacts-avatar-selector.vala"
			_inner_error0_ = NULL;
#line 1678 "contacts-avatar-selector.c"
		}
		__finally8:
#line 250 "../src/contacts-avatar-selector.vala"
		if (G_UNLIKELY (_inner_error0_ != NULL)) {
#line 250 "../src/contacts-avatar-selector.vala"
			_g_object_unref0 (file);
#line 250 "../src/contacts-avatar-selector.vala"
			_g_object_unref0 (preview);
#line 250 "../src/contacts-avatar-selector.vala"
			_g_object_unref0 (pixbuf);
#line 250 "../src/contacts-avatar-selector.vala"
			_g_free0 (uri);
#line 250 "../src/contacts-avatar-selector.vala"
			g_critical ("file %s: line %d: uncaught error: %s (%s, %d)", __FILE__, __LINE__, _inner_error0_->message, g_quark_to_string (_inner_error0_->domain), _inner_error0_->code);
#line 250 "../src/contacts-avatar-selector.vala"
			g_clear_error (&_inner_error0_);
#line 250 "../src/contacts-avatar-selector.vala"
			return;
#line 1697 "contacts-avatar-selector.c"
		}
#line 262 "../src/contacts-avatar-selector.vala"
		if (G_TYPE_CHECK_INSTANCE_TYPE (chooser, gtk_dialog_get_type ())) {
#line 1701 "contacts-avatar-selector.c"
			GdkPixbuf* _tmp18_;
#line 263 "../src/contacts-avatar-selector.vala"
			_tmp18_ = pixbuf;
#line 263 "../src/contacts-avatar-selector.vala"
			gtk_dialog_set_response_sensitive (G_TYPE_CHECK_INSTANCE_CAST (chooser, gtk_dialog_get_type (), GtkDialog), (gint) GTK_RESPONSE_ACCEPT, _tmp18_ != NULL);
#line 1707 "contacts-avatar-selector.c"
		}
#line 265 "../src/contacts-avatar-selector.vala"
		_tmp19_ = pixbuf;
#line 265 "../src/contacts-avatar-selector.vala"
		if (_tmp19_ != NULL) {
#line 1713 "contacts-avatar-selector.c"
			GtkImage* _tmp20_;
			GdkPixbuf* _tmp21_;
#line 266 "../src/contacts-avatar-selector.vala"
			_tmp20_ = preview;
#line 266 "../src/contacts-avatar-selector.vala"
			_tmp21_ = pixbuf;
#line 266 "../src/contacts-avatar-selector.vala"
			gtk_image_set_from_pixbuf (_tmp20_, _tmp21_);
#line 1722 "contacts-avatar-selector.c"
		} else {
			GtkImage* _tmp22_;
#line 268 "../src/contacts-avatar-selector.vala"
			_tmp22_ = preview;
#line 268 "../src/contacts-avatar-selector.vala"
			gtk_image_set_from_icon_name (_tmp22_, "dialog-question", (GtkIconSize) GTK_ICON_SIZE_DIALOG);
#line 1729 "contacts-avatar-selector.c"
		}
#line 244 "../src/contacts-avatar-selector.vala"
		_g_object_unref0 (file);
#line 244 "../src/contacts-avatar-selector.vala"
		_g_object_unref0 (preview);
#line 244 "../src/contacts-avatar-selector.vala"
		_g_object_unref0 (pixbuf);
#line 1737 "contacts-avatar-selector.c"
	}
#line 271 "../src/contacts-avatar-selector.vala"
	gtk_file_chooser_set_preview_widget_active (chooser, TRUE);
#line 242 "../src/contacts-avatar-selector.vala"
	_g_free0 (uri);
#line 1743 "contacts-avatar-selector.c"
}

static void
contacts_avatar_selector_class_init (ContactsAvatarSelectorClass * klass,
                                     gpointer klass_data)
{
#line 30 "../src/contacts-avatar-selector.vala"
	contacts_avatar_selector_parent_class = g_type_class_peek_parent (klass);
#line 30 "../src/contacts-avatar-selector.vala"
	g_type_class_adjust_private_offset (klass, &ContactsAvatarSelector_private_offset);
#line 30 "../src/contacts-avatar-selector.vala"
	G_OBJECT_CLASS (klass)->finalize = contacts_avatar_selector_finalize;
#line 30 "../src/contacts-avatar-selector.vala"
	gtk_widget_class_set_template_from_resource (GTK_WIDGET_CLASS (klass), "/org/gnome/Contacts/ui/contacts-avatar-selector.ui");
#line 1758 "contacts-avatar-selector.c"
	/**
	   * Fired after the user has definitely chosen a new avatar.
	   */
#line 30 "../src/contacts-avatar-selector.vala"
	contacts_avatar_selector_signals[CONTACTS_AVATAR_SELECTOR_SET_AVATAR_SIGNAL] = g_signal_new ("set-avatar", CONTACTS_TYPE_AVATAR_SELECTOR, G_SIGNAL_RUN_LAST, 0, NULL, NULL, g_cclosure_marshal_VOID__OBJECT, G_TYPE_NONE, 1, g_icon_get_type ());
#line 30 "../src/contacts-avatar-selector.vala"
	gtk_widget_class_bind_template_child_full (GTK_WIDGET_CLASS (klass), "personas_thumbnail_grid", FALSE, ContactsAvatarSelector_private_offset + G_STRUCT_OFFSET (ContactsAvatarSelectorPrivate, personas_thumbnail_grid));
#line 30 "../src/contacts-avatar-selector.vala"
	gtk_widget_class_bind_template_child_full (GTK_WIDGET_CLASS (klass), "stock_thumbnail_grid", FALSE, ContactsAvatarSelector_private_offset + G_STRUCT_OFFSET (ContactsAvatarSelectorPrivate, stock_thumbnail_grid));
#line 30 "../src/contacts-avatar-selector.vala"
	gtk_widget_class_bind_template_child_full (GTK_WIDGET_CLASS (klass), "cheese_button", FALSE, ContactsAvatarSelector_private_offset + G_STRUCT_OFFSET (ContactsAvatarSelectorPrivate, cheese_button));
#line 30 "../src/contacts-avatar-selector.vala"
	gtk_widget_class_bind_template_callback_full (GTK_WIDGET_CLASS (klass), "on_cheese_clicked", G_CALLBACK(_contacts_avatar_selector_on_cheese_clicked_gtk_button_clicked));
#line 30 "../src/contacts-avatar-selector.vala"
	gtk_widget_class_bind_template_callback_full (GTK_WIDGET_CLASS (klass), "on_file_clicked", G_CALLBACK(_contacts_avatar_selector_on_file_clicked_gtk_button_clicked));
#line 1774 "contacts-avatar-selector.c"
}

static void
contacts_avatar_selector_instance_init (ContactsAvatarSelector * self,
                                        gpointer klass)
{
#line 30 "../src/contacts-avatar-selector.vala"
	self->priv = contacts_avatar_selector_get_instance_private (self);
#line 30 "../src/contacts-avatar-selector.vala"
	gtk_widget_init_template (GTK_WIDGET (self));
#line 1785 "contacts-avatar-selector.c"
}

static void
contacts_avatar_selector_finalize (GObject * obj)
{
	ContactsAvatarSelector * self;
#line 30 "../src/contacts-avatar-selector.vala"
	self = G_TYPE_CHECK_INSTANCE_CAST (obj, CONTACTS_TYPE_AVATAR_SELECTOR, ContactsAvatarSelector);
#line 36 "../src/contacts-avatar-selector.vala"
	_g_object_unref0 (self->priv->thumbnail_factory);
#line 37 "../src/contacts-avatar-selector.vala"
	_g_object_unref0 (self->priv->individual);
#line 40 "../src/contacts-avatar-selector.vala"
	_g_object_unref0 (self->priv->personas_thumbnail_grid);
#line 42 "../src/contacts-avatar-selector.vala"
	_g_object_unref0 (self->priv->stock_thumbnail_grid);
#line 46 "../src/contacts-avatar-selector.vala"
	_g_object_unref0 (self->priv->cheese_button);
#line 48 "../src/contacts-avatar-selector.vala"
	_g_object_unref0 (self->priv->camera_monitor);
#line 30 "../src/contacts-avatar-selector.vala"
	G_OBJECT_CLASS (contacts_avatar_selector_parent_class)->finalize (obj);
#line 1808 "contacts-avatar-selector.c"
}

/**
 * The AvatarSelector can be used to choose the avatar for a contact.
 * This can be done by either choosing a stock thumbnail, an image file
 * provided by the user, or -if cheese is enabled- by using a webcam.
 *
 * After a user has initially chosen an avatar, we provide a cropping tool.
 */
static GType
contacts_avatar_selector_get_type_once (void)
{
	static const GTypeInfo g_define_type_info = { sizeof (ContactsAvatarSelectorClass), (GBaseInitFunc) NULL, (GBaseFinalizeFunc) NULL, (GClassInitFunc) contacts_avatar_selector_class_init, (GClassFinalizeFunc) NULL, NULL, sizeof (ContactsAvatarSelector), 0, (GInstanceInitFunc) contacts_avatar_selector_instance_init, NULL };
	GType contacts_avatar_selector_type_id;
	contacts_avatar_selector_type_id = g_type_register_static (gtk_popover_get_type (), "ContactsAvatarSelector", &g_define_type_info, 0);
	ContactsAvatarSelector_private_offset = g_type_add_instance_private (contacts_avatar_selector_type_id, sizeof (ContactsAvatarSelectorPrivate));
	return contacts_avatar_selector_type_id;
}

GType
contacts_avatar_selector_get_type (void)
{
	static volatile gsize contacts_avatar_selector_type_id__volatile = 0;
	if (g_once_init_enter (&contacts_avatar_selector_type_id__volatile)) {
		GType contacts_avatar_selector_type_id;
		contacts_avatar_selector_type_id = contacts_avatar_selector_get_type_once ();
		g_once_init_leave (&contacts_avatar_selector_type_id__volatile, contacts_avatar_selector_type_id);
	}
	return contacts_avatar_selector_type_id__volatile;
}

static void
_vala_array_destroy (gpointer array,
                     gint array_length,
                     GDestroyNotify destroy_func)
{
	if ((array != NULL) && (destroy_func != NULL)) {
		gint i;
		for (i = 0; i < array_length; i = i + 1) {
			if (((gpointer*) array)[i] != NULL) {
				destroy_func (((gpointer*) array)[i]);
			}
		}
	}
}

static void
_vala_array_free (gpointer array,
                  gint array_length,
                  GDestroyNotify destroy_func)
{
	_vala_array_destroy (array, array_length, destroy_func);
	g_free (array);
}

